#!/bin/bash

# EDIT THE FOLLOWING VARIABLES FOR SELECTING THE TEMPORARY .sh FILE, AND THE MYSQL CONNECTION OPTIONS.
# LEAVE MYSQL_PASS BLANK IF YOU WANT TO BE PROMPTED FOR MYSQL PASSWORD

TMP_SH_FILE=/tmp/kill-sleeping-threads.sh
MYSQL_BIN=mysql
MYSQL_USER=root
MYSQL_PASS=
STATE_TO_KILL="Sleep"
TIME=

if [ "$TIME" = "" ]; then
OPTIONAL_TIME_FILTER=''
else
OPTIONAL_TIME_FILTER="AND Time > $TIME"
fi

echo '#!/bin/bash' > $TMP_SH_FILE
echo >> $TMP_SH_FILE
echo "$MYSQL_BIN -u$MYSQL_USER -p$MYSQL_PASS -e \"" >> $TMP_SH_FILE

$MYSQL_BIN -u$MYSQL_USER -p$MYSQL_PASS -B -e "SELECT CONCAT('KILL ',id,';') FROM information_schema.processlist WHERE state='$STATE_TO_KILL' $OPTIONAL_TIME_FILTER" | grep -iv "concat" >> $TMP_SH_FILE

echo "\"" >> $TMP_SH_FILE

# UNCOMMENT THE FOLLOWING LIKE TO SEE THE CONTENTS OF THE CREATED TEMPORARY .sh FILE
#cat $TMP_SH_FILE

# UNCOMMENT THE FOLLOWING LINE TO RUN THE SCRIPT THAT KILLS THE CONNECTIONS
# NOTE THAT THIS MAY KILL CONNECTIONS THAT HAVE CHANGED STATE SINCE THE information_schema WAS POLLED. SO RUN THIS AT YOUR OWN RISK :)
#sh $TMP_SH_FILE

exit 0
